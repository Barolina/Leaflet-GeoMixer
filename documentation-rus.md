# Документация плагина Leaflet-GeoMixer

Leaflet-GeoMixer - плагин для интеграции данных с серверов ГеоМиксера в любую карту, созданную с использованием библиотеки Leaflet. 
Плагин добавляет несколько новых классов для работы с данными и функции для инстанциации этих классов.

## Простой пример

```html
	<div id="map"></div>
 
	<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet-src.js"></script>
	<script src="leaflet-geomixer.js?key=U92596WMIH"></script>
	<script>
		var map = L.map('map').setView([60, 50], 3);
		
		L.gmx.loadLayer('7VKHM', '295894E2A2F742109AB112DBFEAEFF09').then(function(satelliteLayer) {
		    satelliteLayer.addTo(map);
		});
		
        L.gmx.loadMap('AZR6A', {leafletMap: map});
	</script>
```

## Добавление плагина

Чтобы добавить плагин, просто загрузите JS файл на вашей странице:

```html
<script src="leaflet-geomixer.js?key=GeoMixerAPIKey"></script>
```

`GeoMixerAPIKey` - это специальный ключ, который должен быть получен для каждого домена, на котором загружаются данные из GeoMixer'а. 
Этот ключ может быть указан как параметр к подключаемому скрипту или передан как параметр при загрузке слоёв.

## Структуры данных в GeoMixer'e

Основной сущностью в ГеоМиксере является **слой**. Каждый слой имеет ряд свойств, включающих в себя `ID`, `type` и`title`.
ID слоя уникально в пределах одного сервера. Основными типами слоёв являются **векторные** и **растровые**.

Каждый векторный слой состоит из геометрических объектов. Объекты имеют следующие атрибуты: `type`, `geometry` и `properties`. 

Слои в ГеоМиксере объединяются в **карты**.

## Загрузка слоёв

Слои загружаются при помощи фабричных методов в асинхронном режиме. Есть несколько способов загрузить слой.

### L.gmx.loadLayer
```js
 L.gmx.loadLayer(mapID, layerID, options): Promise
```

`mapID` - ID карты ГеоМиксера, а `layerID` - ID слоя внутри этой карты. `options` - хеш дополнительных параметров со следующими возможными ключами.

Параметр|Описание|Тип|Значение по умолчанию
------|-----------|:--:|-------------
hostName| Хост сервера ГеоМиксера (без `http://` и `/` в конце)|`String`|maps.kosmosnimki.ru
apiKey|Ключ ГеоМиксера для загрузки данных. Может быть задан один раз при подключении скрипта плагина (см. выше). Для работы с `localhost` ключ не требуется.|`String`|
beginDate|Начальная дата временного интервала (только для мультиврменных слоёв)|`Date`|
endDate|Конечная дата временного интервала (только для мультиврменных слоёв)|`Date`|

Функция возвращает Promise, который будет завершён с инстансом слоя в качестве первого параметра (см. описание слоёв ниже). 
Этот инстанс может быть использован для добавления слоя на карту, настройки отображения и т.п.

### L.gmx.loadLayers
```js
 L.gmx.loadLayers(layers, commonOptions): Promise
```

Вспомогательная функция для загрузки сразу нескольких слоёв. `layers` - массив объектов со следующими свойствами:
  * mapID - ID карты ГеоМиксера
  * layerID - ID слоя
  * options - дополнительные опции слоя

Каждый элемент массива соответвтует отдельному вызову `L.gmx.loadLayer`. `commonOptions` применяются ко всем слоям.
Возвращает Promise, который будет завершён (fulfill) после загрузки всех слоёв. Слои передаются как отдельные параметры.

### L.gmx.loadMap
```js
 L.gmx.loadMap(mapID, options): Promise
```
Загружает все слои из определённой карты ГеоМиксера.

`options` - набор дополнительных параметров

Параметр|Описание|Тип
------|-----------|:--:|-------------
leafletMap| Карта Leaflet для добавления к ней всех слоёв, включённых в исходной карте ГеоМиксера |`L.Map`

Функция возвращает Promise, который завершается (fulfilled) при загрузке всех слоёв. При этом в ф-ции завершения передаётся объект типа `L.gmx.Map`.

## Класс L.gmx.VectorLayer

Класс `gmxVectorLayer` предоставляет интерфейс для рендеринга векторных слоёв ГеоМиксера на карте Leaflet.
Слои могут быть добавлены к карте при помощи стандартных ф-ций `L.Map.addLayer()` или `L.gmx.VectorLayer.addTo()`.

### Методы
Метод|Синтаксис|Возвращаемое значение|Описание
------|------|:---------:|-----------
setFilter|`setFilter(function(item): Boolean)`|`this`| Установить ф-ция для фильтрации объектов перед рендерингом. Единственный аргумент - ф-ция, которая принимает объект из слоя и возвращает булево значение (`false` - отфильтровать)
setDateInterval|`setDateInterval(beginDate, endDate)`|`this`|Задаёт временной интервал для мультиврменных слоёв. Только объекты из этого интервала будут загружены и показаны на карте. `beginDate` и `endDate` имеют тип `Date`.
addTo|`addTo(map)`|`this`|Добавить слой на карту. Аргемент `map` имеет тип `L.Map`.

## Класс L.gmx.RasterLayer

Класс `L.gmx.RasterLayer` рисует на карте растровые слои ГеоМиксера.

Method|Syntax|Return type|Description
------|------|:---------:|-----------
addTo|`addTo(map)`|`this`|Добавить слой на карту. Аргемент `map` имеет тип `L.Map`.

## Класс L.gmx.Map
Класс `L.gmx.Map` используется для работы с картой ГеоМиксера (как с набором слоёв). Он включает ряд свойств для итерирования и поиска слоёв из карты.

###Свойства

Свойсто|Тип|Описание
------|:---------:|-----------
layers|`L.gmx.VectorLayer[]` или `L.gmx.RasterLayer[]`| Массив всех слоёв из Карты ГеоМиксера
layersByID|Object| Хеш слоёв с ID слоя в качестве ключа хеша
layersByTitle|Object| Хеш слоёв с заголовком (title) слоя в качестве ключа хеша